<!doctype html>
<html lang="{{ current_language }}" dir="{{ language_direction }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyTakaful</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='logo.svg') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* Admin Sidebar Styles */
    .sidebar {
      background-color: rgba(249, 250, 251, 0.9); /* light gray-white semi-transparent */
      border-right: 1px solid rgba(229, 231, 235, 0.5); /* subtle border */
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05); /* subtle shadow */
      border-radius: 0;
      transition: all 0.3s ease;
    }
    
    .sidebar nav {
      display: flex;
      flex-direction: column;
      padding: 16px 0;
    }
    
    .sidebar nav a {
      padding: 10px 16px;
      margin: 4px 8px;
      border-radius: 8px; /* slightly rounded corners */
      color: #374151; /* readable text color */
      text-decoration: none;
      transition: all 0.2s ease;
      display: block;
    }
    
    .sidebar nav a:hover {
      background-color: rgba(209, 213, 219, 0.3); /* slightly darker background on hover */
      color: #1f2937; /* slightly darker text on hover */
    }
    
    .sidebar.collapsed {
      width: 60px;
    }
    
    .sidebar.collapsed nav a {
      text-align: center;
      padding: 12px 5px;
      font-size: 0;
    }
    
    .sidebar.collapsed nav a::first-letter {
      font-size: 16px;
    }
  </style>
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="icon-banknotes" viewBox="0 0 24 24">
      <rect x="3" y="6" width="18" height="12" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <line x1="7" y1="10" x2="17" y2="10" stroke="currentColor" stroke-width="2"/>
      <circle cx="12" cy="13" r="2.5" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24">
      <rect x="3" y="5" width="18" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <line x1="8" y1="3" x2="8" y2="7" stroke="currentColor" stroke-width="2"/>
      <line x1="16" y1="3" x2="16" y2="7" stroke="currentColor" stroke-width="2"/>
      <line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="icon-gift" viewBox="0 0 24 24">
      <rect x="4" y="10" width="16" height="10" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M4 10h16M12 10v10" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M7 6c0-1.5 1.2-2.5 2.7-2.5C11 3.5 12 5 12 6c0-1 1-2.5 2.3-2.5C15.8 3.5 17 4.5 17 6c0 1.5-1.2 2.5-2.7 2.5H9.7C8.2 8.5 7 7.5 7 6z" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="icon-clock" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M12 7v6l4 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="icon-credit-card" viewBox="0 0 24 24">
      <rect x="3" y="5" width="18" height="14" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" stroke-width="2"/>
      <rect x="7" y="13" width="6" height="2" fill="currentColor"/>
    </symbol>
    <symbol id="icon-eye" viewBox="0 0 24 24">
      <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" fill="none" stroke="currentColor" stroke-width="2"/>
      <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="icon-arrow-left" viewBox="0 0 24 24">
      <path d="M10 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="icon-currency" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M9 8c1-.8 2-.8 3-.8 2 0 3 .8 3 2 0 2-3 2-3 2s-3 0-3 2 1 2 3 2c1 0 2 0 3-.8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="12" y1="6" x2="12" y2="18" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="icon-handshake" viewBox="0 0 24 24">
      <path d="M8 12l3 3c.6.6 1.6.6 2.2 0l3.8-3.8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M6 9l3 3 2-2-3-3c-.9-.9-2.4-.9-3.3 0L3 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M18 9l-3 3-2-2 3-3c.9-.9 2.4-.9 3.3 0L21 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
  </svg>
  <script>
    function toggleSidebar(){
      var el=document.querySelector('.sidebar');
      if(el){ el.classList.toggle('collapsed'); return; }
      // For non-admin users or when sidebar doesn't exist, we could implement a mobile menu
      var nav=document.querySelector('.header-nav');
      if(nav){ nav.classList.toggle('open'); }
    }
  </script>
  {% block head %}{% endblock %}
</head>
<body{% if g.user and g.user.role == 'admin' %} data-user-role="admin"{% endif %}>
  <header class="header">
    {% if g.user and g.user.role == 'admin' %}
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
    {% endif %}
    <div class="brand">
      <a class="brand-link" href="{% if not g.user %}{{ url_for('login') }}{% elif g.user.role == 'admin' %}{{ url_for('admin') }}{% else %}{{ url_for('groups') }}{% endif %}">
        <svg class="brand-icon" role="img" aria-label="Logo MyTakaful"><use href="#icon-handshake"></use></svg>
        <span class="app-name">MyTakaful</span>
      </a>
    </div>
    <!-- Language Selector -->
    <div class="language-selector">
      <select onchange="window.location.href='/set_language/'+this.value" class="language-select">
        {% for lang in available_languages %}
          <option value="{{ lang.lang_code }}" {% if lang.lang_code == current_language %}selected{% endif %}>
            {{ lang.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    {% if not g.user %}
      <nav class="header-nav">
        <a href="{{ url_for('home') }}">{{ t('navigation.home') }}</a>
        <a href="{{ url_for('home') }}#about">{{ t('navigation.about') }}</a>
        <a href="{{ url_for('home') }}#features">{{ t('navigation.features') }}</a>
        <a href="{{ url_for('home') }}#how">{{ t('navigation.how_it_works') }}</a>
      </nav>
    {% elif g.user and g.user.role != 'admin' %}
      <nav class="header-nav">
        <a href="{{ url_for('groups') }}">{{ t('navigation.groups') }}</a>
        <a href="{{ url_for('dashboard') }}">{{ t('navigation.dashboard') }}</a>
        <a href="{{ url_for('logout') }}">{{ t('navigation.logout') }}</a>
      </nav>
    {% endif %}
    <div class="header-actions">
      <button class="theme-toggle" id="themeToggle" aria-label="{{ t('theme.toggle') }}">
        <svg class="theme-icon sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="theme-icon moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      {% if g.user %}
        <div class="notif"><span id="notifBadge" class="badge">0</span></div>
        <div class="user-menu"><span>{{ g.user.name }}</span>
          <div class="dropdown">
            <a href="{{ url_for('profile') }}">{{ t('navigation.profile') }}</a>
            <a href="{{ url_for('logout') }}">{{ t('navigation.logout') }}</a>
          </div>
        </div>
      {% else %}
        <a class="btn btn-primary" href="{{ url_for('login') }}">{{ t('navigation.login') }}</a>
        <a class="btn btn-secondary" href="{{ url_for('register') }}">{{ t('navigation.register') }}</a>
      {% endif %}
    </div>
  </header>
  <div class="layout">
    {% if g.user and g.user.role == 'admin' %}
      <aside class="sidebar">
        <nav>
          <a href="{{ url_for('admin') }}">{{ t('dashboard.admin.title') }}</a>
          <a href="{{ url_for('admin_users') }}">{{ t('dashboard.admin.users') }}</a>
          <a href="{{ url_for('admin_groups') }}">{{ t('dashboard.admin.groups') }}</a>
          <a href="{{ url_for('admin_transactions') }}">{{ t('dashboard.admin.transactions') }}</a>
          <a href="{{ url_for('admin') }}#aids">{{ t('dashboard.admin.aids') }}</a>
          <a href="{{ url_for('admin_group_statistics') }}">{{ t('dashboard.admin.statistics') }}</a>
          <a href="{{ url_for('export_csv') }}">{{ t('dashboard.admin.export_csv') }}</a>
          <a href="{{ url_for('export_pdf') }}">{{ t('dashboard.admin.export_pdf') }}</a>
        </nav>
      </aside>
    {% endif %}
    <main class="content">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="toast">
            {% for m in messages %}
              <div class="toast-item">{{ m }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
  </div>
  <script>
    // Theme switching functionality
    (function() {
      const themeToggle = document.getElementById('themeToggle');
      const body = document.body;
      
      // Check for saved theme preference or respect OS preference
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
      
      // Apply initial theme
      if (initialTheme === 'dark') {
        body.classList.add('dark-mode');
      }
      
      // Toggle theme function
      function toggleTheme() {
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        
        // Dispatch event for other scripts to listen to
        window.dispatchEvent(new CustomEvent('themechange', { detail: { theme: isDark ? 'dark' : 'light' } }));
      }
      
      // Add event listener if toggle exists
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }
    })();
    
    document.addEventListener('click', function(e){
      var menu = document.querySelector('.user-menu'); if(!menu) return;
      if(menu.contains(e.target)){ menu.classList.toggle('open'); } else { menu.classList.remove('open'); }
    });
    {% if g.user %}
    try{
      var es = new EventSource("{{ url_for('notifications_stream') }}");
      es.onmessage = function(ev){
        var b=document.getElementById('notifBadge'); var wrap=document.querySelector('.toast');
        var d; try{d=JSON.parse(ev.data)}catch(_){d=[]};
        var inc=(d&&d.length)?d.length:1; var cur=b?parseInt(b.textContent||'0'):0; if(b){ b.textContent=String(cur+inc); }
        if(wrap){
          (d||[]).forEach(function(it){ var el=document.createElement('div'); el.className='toast-item fade'; el.textContent=it.message; wrap.appendChild(el); requestAnimationFrame(function(){ el.classList.add('in'); }); setTimeout(function(){ el.remove(); }, 6000); });
        }
      };
    }catch(_){}
    {% endif %}
  </script>
  
  <!-- AI Assistant Floating Button -->
  <div id="ai-assistant-container" class="ai-assistant-container">
    <button id="ai-assistant-toggle" class="ai-assistant-toggle">
      <span class="ai-icon">&#129302;</span>
      <span class="ai-text">{{ t('ai_assistant.title') }}</span>
    </button>
    <div id="ai-assistant-chat" class="ai-assistant-chat">
      <div class="ai-chat-header">
        <h3>{{ t('ai_assistant.title') }}</h3>
        <button id="ai-chat-close" class="ai-chat-close">&times;</button>
      </div>
      <div class="ai-chat-body">
        <div id="ai-chat-messages" class="ai-chat-messages">
          <div class="ai-message ai-bot-message">
            <div class="ai-message-content">
              {{ t('ai_assistant.help_title') }}
            </div>
          </div>
        </div>
        <div class="ai-suggestions" id="ai-suggestions">
          <!-- Suggestions will be loaded here -->
        </div>
        <form id="ai-chat-form" class="ai-chat-form">
          <input type="text" id="ai-question" name="question" placeholder="{{ t('ai_assistant.placeholder') }}" required>
          <button type="submit" class="ai-send-button">{{ t('ai_assistant.send') }}</button>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    // AI Assistant functionality
    document.addEventListener('DOMContentLoaded', function() {
      const aiToggle = document.getElementById('ai-assistant-toggle');
      const aiChat = document.getElementById('ai-assistant-chat');
      const aiClose = document.getElementById('ai-chat-close');
      const aiForm = document.getElementById('ai-chat-form');
      const aiQuestion = document.getElementById('ai-question');
      const aiMessages = document.getElementById('ai-chat-messages');
      const aiSuggestions = document.getElementById('ai-suggestions');
      
      // Toggle chat visibility
      aiToggle.addEventListener('click', function() {
        aiChat.classList.toggle('open');
        if (aiChat.classList.contains('open')) {
          loadSuggestions();
          aiQuestion.focus();
        }
      });
      
      // Close chat
      aiClose.addEventListener('click', function() {
        aiChat.classList.remove('open');
      });
      
      // Handle form submission
      aiForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const question = aiQuestion.value.trim();
        if (!question) return;
        
        // Add user message
        addMessage(question, 'user');
        aiQuestion.value = '';
        
        // Show loading indicator
        const loadingMsg = addMessage('{{ t("common.loading") }}', 'bot');
        
        // Send request to AI assistant
        fetch('/ai_assistant', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: 'question=' + encodeURIComponent(question)
        })
        .then(response => response.json())
        .then(data => {
          // Remove loading message
          aiMessages.removeChild(loadingMsg);
          
          // Add bot response
          addMessage(data.response, 'bot');
          
          // Scroll to bottom
          aiMessages.scrollTop = aiMessages.scrollHeight;
        })
        .catch(error => {
          // Remove loading message
          aiMessages.removeChild(loadingMsg);
          
          // Show error message
          addMessage('{{ t("messages.error") }}: ' + error.message, 'bot');
        });
      });
      
      // Add message to chat
      function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message ' + (sender === 'user' ? 'ai-user-message' : 'ai-bot-message');
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'ai-message-content';
        contentDiv.textContent = text;
        
        messageDiv.appendChild(contentDiv);
        aiMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        aiMessages.scrollTop = aiMessages.scrollHeight;
        
        return messageDiv;
      }
      
      // Load suggestions
      function loadSuggestions() {
        fetch('/ai_suggestions')
          .then(response => response.json())
          .then(data => {
            aiSuggestions.innerHTML = '';
            data.suggestions.forEach(suggestion => {
              const suggestionBtn = document.createElement('button');
              suggestionBtn.className = 'ai-suggestion-btn';
              suggestionBtn.textContent = suggestion;
              suggestionBtn.addEventListener('click', function() {
                aiQuestion.value = suggestion;
                aiQuestion.focus();
              });
              aiSuggestions.appendChild(suggestionBtn);
            });
          })
          .catch(error => {
            console.error('Error loading suggestions:', error);
          });
      }
    });
  </script>
</body>
</html>
